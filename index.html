!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Invitation System</title>
    <style>
        :root {
            --color-primary: #6366f1;
            --color-primary-hover: #4f46e5;
            --color-primary-active: #4338ca;
            --color-secondary: #f3f4f6;
            --color-secondary-hover: #e5e7eb;
            --color-background: #fafafa;
            --color-surface: #ffffff;
            --color-text: #111827;
            --color-text-secondary: #6b7280;
            --color-border: #e5e7eb;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--color-text);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn:focus-visible {
            outline: 3px solid rgba(99, 102, 241, 0.4);
            outline-offset: 2px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            padding: 24px;
            box-shadow: var(--shadow-lg);
            height: fit-content;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .nav-item:hover {
            background: var(--color-secondary);
            color: var(--color-text);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--shadow-lg);
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.4s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--color-text);
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.3s ease;
            background: var(--color-surface);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .voice-recorder {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: var(--radius-lg);
            padding: 32px;
            text-align: center;
            border: 2px dashed var(--color-primary);
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }

        .record-btn.recording {
            animation: pulse 1.5s infinite;
            background: var(--color-error);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .waveform {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin: 20px 0;
        }

        .waveform-bar {
            width: 4px;
            height: 20px;
            background: var(--color-primary);
            border-radius: 2px;
            transition: height 0.2s ease;
        }

        .waveform.active .waveform-bar {
            animation: waveAnimation 1s infinite ease-in-out;
        }

        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes waveAnimation {
            0%, 100% { height: 20px; }
            50% { height: 50px; }
        }

        .contact-list {
            display: grid;
            gap: 12px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .contact-item:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-sm);
        }

        .contact-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .contact-details h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-details p {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .contact-actions {
            display: flex;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--color-border);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-sent { background: rgba(59, 130, 246, 0.1); color: var(--color-info); }
        .status-delivered { background: rgba(16, 185, 129, 0.1); color: var(--color-success); }
        .status-pending { background: rgba(245, 158, 11, 0.1); color: var(--color-warning); }
        .status-failed { background: rgba(239, 68, 68, 0.1); color: var(--color-error); }

        .invitation-preview {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 2px solid var(--color-border);
            margin-top: 20px;
        }

        .audio-player {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--color-surface);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            margin-top: 12px;
        }

        .audio-player audio {
            width: 100%;
        }

        .progress-bar {
            height: 8px;
            background: var(--color-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--color-secondary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--color-error);
            color: white;
            transform: rotate(90deg);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--color-border);
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--color-text-secondary);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--color-primary);
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.show {
            display: flex;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .notification.success { border-left: 4px solid var(--color-success); }
        .notification.error { border-left: 4px solid var(--color-error); }
        .notification.info { border-left: 4px solid var(--color-info); }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            .content-area {
                padding: 20px;
            }
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .template-card {
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--color-surface);
        }

        .template-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
        }

        .template-card.selected {
            border-color: var(--color-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .template-card[data-template="birthday"] {
            background: linear-gradient(135deg, rgba(255, 107, 181, 0.08) 0%, rgba(255, 193, 7, 0.08) 100%);
            border-color: rgba(233, 30, 99, 0.3);
        }

        .template-card[data-template="birthday"]:hover {
            background: linear-gradient(135deg, rgba(255, 107, 181, 0.15) 0%, rgba(255, 193, 7, 0.15) 100%);
            border-color: #e91e63;
        }

        .template-card[data-template="wedding"] {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.08) 0%, rgba(219, 39, 119, 0.08) 100%);
            border-color: rgba(219, 39, 119, 0.3);
        }

        .template-card[data-template="wedding"]:hover {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15) 0%, rgba(219, 39, 119, 0.15) 100%);
            border-color: #db2777;
        }

        .template-card[data-template="party"] {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(219, 39, 119, 0.08) 100%);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .template-card[data-template="party"]:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(219, 39, 119, 0.15) 100%);
            border-color: #8b5cf6;
        }

        .template-card[data-template="meeting"] {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.08) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .template-card[data-template="meeting"]:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.15) 100%);
            border-color: #3b82f6;
        }

        .template-card[data-template="anniversary"] {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(220, 38, 38, 0.08) 100%);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .template-card[data-template="anniversary"]:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
            border-color: #ef4444;
        }

        .template-card[data-template="custom"] {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .template-card[data-template="custom"]:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border-color: #6366f1;
        }

        .template-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .template-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .template-description {
            font-size: 12px;
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>
                <span>üéôÔ∏è</span>
                AI Voice Invitation System
            </h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openModal('addContactModal')" aria-label="Add new contact">
                    ‚ûï Add Contact
                </button>
                <button class="btn btn-primary" onclick="openModal('createInviteModal')" aria-label="Create new invitation">
                    ‚ú® Create Invitation
                </button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <nav role="navigation" aria-label="Main navigation">
                    <div class="nav-item active" onclick="switchSection('dashboard')" role="button" tabindex="0" aria-label="Dashboard">
                        üìä Dashboard
                    </div>
                    <div class="nav-item" onclick="switchSection('invitations')" role="button" tabindex="0" aria-label="My Invitations">
                        üíå My Invitations
                    </div>
                    <div class="nav-item" onclick="switchSection('contacts')" role="button" tabindex="0" aria-label="Contacts">
                        üë• Contacts
                    </div>
                    <div class="nav-item" onclick="switchSection('voice')" role="button" tabindex="0" aria-label="Voice Clone">
                        üé§ Voice Clone
                    </div>
                    <div class="nav-item" onclick="switchSection('templates')" role="button" tabindex="0" aria-label="Templates">
                        üìù Templates
                    </div>
                    <div class="nav-item" onclick="switchSection('analytics')" role="button" tabindex="0" aria-label="Analytics">
                        üìà Analytics
                    </div>
                </nav>
            </aside>

            <main class="content-area">
                <!-- Dashboard Section -->
                <section id="dashboard" class="section active">
                    <h2 class="section-title">Dashboard Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalInvites">12</div>
                            <div class="stat-label">Total Invitations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="deliveredCount">8</div>
                            <div class="stat-label">Delivered</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pendingCount">3</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="responseRate">75%</div>
                            <div class="stat-label">Response Rate</div>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 16px; font-size: 18px;">Recent Activity</h3>
                    <div id="recentActivity">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="font-weight: 600; margin-bottom: 8px;">Birthday Party Invitation</h4>
                                    <p style="font-size: 14px; color: var(--color-text-secondary);">Sent to 5 contacts ‚Ä¢ 2 hours ago</p>
                                </div>
                                <span class="status-badge status-delivered">Delivered</span>
                            </div>
                        </div>
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="font-weight: 600; margin-bottom: 8px;">Wedding Anniversary</h4>
                                    <p style="font-size: 14px; color: var(--color-text-secondary);">Sent to 15 contacts ‚Ä¢ 5 hours ago</p>
                                </div>
                                <span class="status-badge status-sent">Sent</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Invitations Section -->
                <section id="invitations" class="section">
                    <h2 class="section-title">My Invitations</h2>
                    <div id="invitationsList"></div>
                </section>

                <!-- Contacts Section -->
                <section id="contacts" class="section">
                    <h2 class="section-title">Contact Management</h2>
                    <div class="contact-list" id="contactsList"></div>
                </section>

                <!-- Voice Clone Section -->
                <section id="voice" class="section">
                    <h2 class="section-title">Voice Cloning Studio</h2>
                    
                    <div class="card">
                        <div class="voice-recorder">
                            <h3 style="margin-bottom: 16px;">Record Your Voice Sample</h3>
                            <p style="color: var(--color-text-secondary); margin-bottom: 8px;">
                                <strong>üìù Instructions:</strong>
                            </p>
                            <ul style="color: var(--color-text-secondary); margin-bottom: 24px; padding-left: 20px; line-height: 1.8;">
                                <li>Click the microphone button below to start recording</li>
                                <li>Allow microphone access when your browser prompts you</li>
                                <li>Speak clearly for at least 30 seconds for best AI cloning results</li>
                                <li>Click again to stop recording and save</li>
                            </ul>
                            
                            <button class="record-btn" id="recordBtn" onclick="toggleRecording()" aria-label="Start or stop recording">
                                <span style="font-size: 32px;">üéôÔ∏è</span>
                            </button>
                            
                            <div class="waveform" id="waveform">
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                            </div>
                            
                            <div id="recordingTime" style="font-size: 24px; font-weight: 600; color: var(--color-primary); margin-top: 16px;">
                                00:00
                            </div>
                            
                            <div id="recordingStatus" style="margin-top: 12px; color: var(--color-text-secondary);">
                                Click to start recording
                            </div>
                        </div>

                        <div id="recordedAudioContainer" style="display: none; margin-top: 24px;">
                            <h4 style="margin-bottom: 12px;">Your Recording</h4>
                            <div class="audio-player">
                                <audio id="audioPlayback" controls></audio>
                            </div>
                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <button class="btn btn-success" onclick="saveVoiceClone()">üíæ Save Voice Clone</button>
                                <button class="btn btn-secondary" onclick="discardRecording()">üóëÔ∏è Discard</button>
                            </div>
                        </div>

                        <div id="savedVoices" style="margin-top: 32px;">
                            <h4 style="margin-bottom: 16px;">Saved Voice Clones</h4>
                            <p style="font-size: 12px; color: var(--color-text-secondary); margin-bottom: 12px;">
                                These recordings are permanently saved in localStorage on this device
                            </p>
                            <div id="voicesList"></div>
                        </div>
                    </div>
                </section>

                <!-- Templates Section -->
                <section id="templates" class="section">
                    <h2 class="section-title">Invitation Templates</h2>
                    <div class="template-grid" id="templateGrid"></div>
                </section>

                <!-- Analytics Section -->
                <section id="analytics" class="section">
                    <h2 class="section-title">Analytics & Tracking</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="analyticsTotal">0</div>
                            <div class="stat-label">Total Sent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="analyticsAccepted">0</div>
                            <div class="stat-label">Accepted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="analyticsPending">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="analyticsDeclined">0</div>
                            <div class="stat-label">Declined</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 16px;">Detailed Invitation Tracking</h3>
                        <div id="analyticsDetails"></div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Create Invitation Modal -->
    <div id="createInviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Invitation</h3>
                <button class="close-btn" onclick="closeModal('createInviteModal')" aria-label="Close modal">‚úï</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('compose')">Compose</button>
                <button class="tab" onclick="switchTab('selectVoice')">Select Voice</button>
                <button class="tab" onclick="switchTab('recipients')">Recipients</button>
            </div>

            <div id="composeTab" class="tab-content">
                <div class="form-group">
                    <label class="form-label" for="inviteTitle">Invitation Title</label>
                    <input type="text" id="inviteTitle" class="form-control" placeholder="e.g., Birthday Party" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="inviteMessage">Message</label>
                    <textarea id="inviteMessage" class="form-control" placeholder="Write your invitation message here..." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="eventDate">Event Date & Time</label>
                    <input type="datetime-local" id="eventDate" class="form-control" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="eventLocation">Location</label>
                    <input type="text" id="eventLocation" class="form-control" placeholder="Event venue or address">
                </div>
            </div>

            <div id="selectVoiceTab" class="tab-content" style="display: none;">
                <div id="voiceSelection"></div>
            </div>

            <div id="recipientsTab" class="tab-content" style="display: none;">
                <div id="recipientSelection"></div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-primary" onclick="createInvitation()" style="flex: 1;">üöÄ Send Invitation</button>
                <button class="btn btn-secondary" onclick="previewInvitation()">üëÅÔ∏è Preview</button>
            </div>
        </div>
    </div>

    <!-- Preview Invitation Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Preview Invitation</h3>
                <button class="close-btn" onclick="closeModal('previewModal')" aria-label="Close modal">‚úï</button>
            </div>

            <div id="previewCard" class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); position: relative; overflow: hidden; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); border: 3px solid transparent;">
                <div id="previewDecoration" style="position: absolute; inset: 0; pointer-events: none; overflow: hidden;"></div>
                
                <div style="position: relative; z-index: 1;">
                    <div style="text-align: center; margin-bottom: 32px;">
                        <h3 id="previewTitle" style="font-size: 36px; font-weight: 700; margin-bottom: 12px; color: var(--color-primary); text-shadow: 0 2px 12px rgba(0, 0, 0, 0.2); letter-spacing: 0.5px;"></h3>
                        <div id="previewSubtitle" style="font-size: 18px; font-style: italic; font-weight: 500; opacity: 0.85; margin-top: 8px;"></div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 28px 32px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1); border: 2px solid rgba(255, 255, 255, 0.3);">
                        <p id="previewMessage" style="font-size: 17px; line-height: 1.9; white-space: pre-wrap; color: #222; text-align: center; font-weight: 400;"></p>
                    </div>
                    
                    <div style="display: grid; gap: 18px; margin-bottom: 28px;">
                        <div id="previewDateCard" style="background: rgba(255, 255, 255, 0.9); padding: 18px 24px; border-radius: 14px; display: flex; align-items: center; gap: 18px; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08); border-left: 4px solid #667eea;">
                            <div style="font-size: 32px; flex-shrink: 0;">üìÖ</div>
                            <div>
                                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; opacity: 0.7; margin-bottom: 6px; color: #667eea;">Date & Time</div>
                                <div id="previewDate" style="font-weight: 600; font-size: 16px; color: #222;"></div>
                            </div>
                        </div>
                        <div id="previewLocationCard" style="background: rgba(255, 255, 255, 0.9); padding: 18px 24px; border-radius: 14px; display: flex; align-items: center; gap: 18px; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08); border-left: 4px solid #667eea;">
                            <div style="font-size: 32px; flex-shrink: 0;">üìç</div>
                            <div>
                                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; opacity: 0.7; margin-bottom: 6px; color: #667eea;">Location</div>
                                <div id="previewLocation" style="font-weight: 600; font-size: 16px; color: #222;"></div>
                            </div>
                        </div>
                        <div id="previewGuestsCard" style="background: rgba(255, 255, 255, 0.9); padding: 18px 24px; border-radius: 14px; display: flex; align-items: center; gap: 18px; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08); border-left: 4px solid #667eea;">
                            <div style="font-size: 32px; flex-shrink: 0;">üë•</div>
                            <div>
                                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; opacity: 0.7; margin-bottom: 6px; color: #667eea;">Invited Guests</div>
                                <div id="previewRecipients" style="font-weight: 600; font-size: 16px; color: #222;"></div>
                            </div>
                        </div>
                    </div>

                    <div id="previewVoice" style="display: none; background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);"></div>
                    
                    <div id="previewFooter" style="text-align: center; margin-top: 32px; padding-top: 24px; border-top: 2px dashed rgba(0, 0, 0, 0.1);"></div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="closeModal('previewModal')" style="flex: 1;">‚Üê Back to Edit</button>
                <button class="btn btn-primary" onclick="closeModal('previewModal'); createInvitation();" style="flex: 1;">‚úÖ Looks Good, Send!</button>
            </div>
        </div>
    </div>

    <!-- View Invitation Modal -->
    <div id="viewInvitationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Invitation Details</h3>
                <button class="close-btn" onclick="closeModal('viewInvitationModal')" aria-label="Close modal">‚úï</button>
            </div>

            <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                    <h3 id="viewTitle" style="color: var(--color-primary);"></h3>
                    <span id="viewStatus" class="status-badge"></span>
                </div>
                
                <p id="viewMessage" style="margin-bottom: 16px; line-height: 1.6; white-space: pre-wrap;"></p>
                
                <div style="display: grid; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <strong>üìÖ Date & Time:</strong>
                        <span id="viewDate"></span>
                    </div>
                    <div>
                        <strong>üìç Location:</strong>
                        <span id="viewLocation"></span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h4 style="margin-bottom: 16px;">üìä Recipient Responses</h4>
                <div id="viewRecipients"></div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="closeModal('viewInvitationModal')">Close</button>
                <button class="btn btn-primary" onclick="closeModal('viewInvitationModal'); resendInvitation(currentViewingInviteId);">üîÑ Resend to Pending</button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Contact</h3>
                <button class="close-btn" onclick="closeModal('addContactModal')" aria-label="Close modal">‚úï</button>
            </div>

            <div class="form-group">
                <label class="form-label" for="contactName">Name</label>
                <input type="text" id="contactName" class="form-control" placeholder="Full name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="contactPhone">Phone Number</label>
                <input type="tel" id="contactPhone" class="form-control" placeholder="+1 234 567 8900" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="contactEmail">Email</label>
                <input type="email" id="contactEmail" class="form-control" placeholder="email@example.com">
            </div>

            <div class="form-group">
                <label class="form-label" for="contactGroup">Group</label>
                <select id="contactGroup" class="form-control">
                    <option value="family">Family</option>
                    <option value="friends">Friends</option>
                    <option value="colleagues">Colleagues</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="addContact()" style="flex: 1;">‚ûï Add Contact</button>
                <button class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationIcon">‚ÑπÔ∏è</span>
        <span id="notificationMessage"></span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        // TODO: Replace with your Firebase project configuration
        // Get this from Firebase Console > Project Settings > Your apps > Firebase SDK snippet
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let db, storage;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            showNotification('Firebase configuration needed. Using localStorage as fallback.', 'info');
        }

        // ========================================
        // DATA STORAGE WITH FIREBASE + LOCALSTORAGE FALLBACK
        // ========================================
        let contacts = [];
        let invitations = [];
        let voiceClones = [];

        // Check if Firebase is configured
        function isFirebaseConfigured() {
            return firebaseConfig.apiKey !== "YOUR_API_KEY" && db !== undefined;
        }

        // Load data from Firebase or localStorage
        async function loadData() {
            if (isFirebaseConfigured()) {
                try {
                    // Load contacts from Firebase
                    const contactsSnapshot = await db.collection('contacts').get();
                    contacts = contactsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Load invitations from Firebase
                    const invitationsSnapshot = await db.collection('invitations').get();
                    invitations = invitationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Load voice clones metadata from Firebase
                    const voiceClonesSnapshot = await db.collection('voiceClones').get();
                    voiceClones = voiceClonesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    console.log('‚úÖ Data loaded from Firebase');
                } catch (error) {
                    console.error('‚ùå Error loading from Firebase:', error);
                    showNotification('Error loading from Firebase, using localStorage', 'error');
                    loadFromLocalStorage();
                }
            } else {
                loadFromLocalStorage();
            }
        }

        // Load from localStorage (fallback)
        function loadFromLocalStorage() {
            contacts = JSON.parse(localStorage.getItem('contacts')) || [
                { id: 1, name: 'John Doe', phone: '+1234567890', email: 'john@example.com', group: 'friends' },
                { id: 2, name: 'Jane Smith', phone: '+1234567891', email: 'jane@example.com', group: 'family' },
                { id: 3, name: 'Mike Johnson', phone: '+1234567892', email: 'mike@example.com', group: 'colleagues' }
            ];
            invitations = JSON.parse(localStorage.getItem('invitations')) || [];
            voiceClones = JSON.parse(localStorage.getItem('voiceClones')) || [];
            console.log('‚úÖ Data loaded from localStorage');
        }

        // Save data to Firebase and localStorage
        async function saveToLocalStorage() {
            // Always save to localStorage as backup
            localStorage.setItem('contacts', JSON.stringify(contacts));
            localStorage.setItem('invitations', JSON.stringify(invitations));
            localStorage.setItem('voiceClones', JSON.stringify(voiceClones));

            // Save to Firebase if configured
            if (isFirebaseConfigured()) {
                try {
                    // Save contacts
                    for (const contact of contacts) {
                        await db.collection('contacts').doc(String(contact.id)).set(contact);
                    }

                    // Save invitations
                    for (const invitation of invitations) {
                        await db.collection('invitations').doc(String(invitation.id)).set(invitation);
                    }

                    // Save voice clones metadata (audio files saved separately)
                    for (const voice of voiceClones) {
                        await db.collection('voiceClones').doc(String(voice.id)).set(voice);
                    }

                    console.log('‚úÖ Data saved to Firebase');
                } catch (error) {
                    console.error('‚ùå Error saving to Firebase:', error);
                    showNotification('Data saved locally. Firebase sync failed.', 'warning');
                }
            }
        }

        // Upload voice recording to Firebase Storage
        async function uploadVoiceToStorage(audioBlob, voiceId) {
            if (!isFirebaseConfigured()) {
                // Fallback to blob URL for localStorage
                return URL.createObjectURL(audioBlob);
            }

            try {
                const storageRef = storage.ref(`voiceClones/${voiceId}.webm`);
                const snapshot = await storageRef.put(audioBlob);
                const downloadURL = await snapshot.ref.getDownloadURL();
                console.log('‚úÖ Voice uploaded to Firebase Storage');
                return downloadURL;
            } catch (error) {
                console.error('‚ùå Error uploading to Firebase Storage:', error);
                showNotification('Voice saved locally. Firebase upload failed.', 'warning');
                return URL.createObjectURL(audioBlob);
            }
        }

        // Delete contact from Firebase
        async function deleteContactFromFirebase(id) {
            if (isFirebaseConfigured()) {
                try {
                    await db.collection('contacts').doc(String(id)).delete();
                    console.log('‚úÖ Contact deleted from Firebase');
                } catch (error) {
                    console.error('‚ùå Error deleting from Firebase:', error);
                }
            }
        }

        // Delete invitation from Firebase
        async function deleteInvitationFromFirebase(id) {
            if (isFirebaseConfigured()) {
                try {
                    await db.collection('invitations').doc(String(id)).delete();
                    console.log('‚úÖ Invitation deleted from Firebase');
                } catch (error) {
                    console.error('‚ùå Error deleting from Firebase:', error);
                }
            }
        }

        // Delete voice clone from Firebase
        async function deleteVoiceCloneFromFirebase(id) {
            if (isFirebaseConfigured()) {
                try {
                    // Delete from Firestore
                    await db.collection('voiceClones').doc(String(id)).delete();
                    
                    // Delete from Storage
                    const storageRef = storage.ref(`voiceClones/${id}.webm`);
                    await storageRef.delete();
                    
                    console.log('‚úÖ Voice clone deleted from Firebase');
                } catch (error) {
                    console.error('‚ùå Error deleting from Firebase:', error);
                }
            }
        }
        let templates = [
            { id: 1, name: 'Birthday', icon: 'üéÇ', description: 'Perfect for birthday celebrations' },
            { id: 2, name: 'Wedding', icon: 'üíí', description: 'Elegant wedding invitations' },
            { id: 3, name: 'Party', icon: 'üéâ', description: 'Fun party invites' },
            { id: 4, name: 'Meeting', icon: 'üìÖ', description: 'Professional meeting invites' },
            { id: 5, name: 'Anniversary', icon: 'üíù', description: 'Special anniversary messages' },
            { id: 6, name: 'Custom', icon: '‚ú®', description: 'Create your own template' }
        ];

        let mediaRecorder;
        let audioChunks = [];
        let recordingInterval;
        let recordingSeconds = 0;
        let isRecording = false;
        let currentViewingInviteId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Load data from Firebase or localStorage
            await loadData();
            
            // Render all sections
            renderContacts();
            renderInvitations();
            renderTemplates();
            renderVoiceClones();
            renderAnalytics();
            updateDashboardStats();

            // Show Firebase status
            if (isFirebaseConfigured()) {
                showNotification('‚úÖ Connected to Firebase - Data syncing enabled', 'success');
            } else {
                showNotification('‚ö†Ô∏è Configure Firebase in the code to enable cloud sync. Currently using localStorage only.', 'info');
            }
        });

        // Analytics rendering
        function renderAnalytics() {
            let totalRecipients = 0;
            let accepted = 0;
            let pending = 0;
            let declined = 0;

            invitations.forEach(invite => {
                invite.recipients.forEach(recipientId => {
                    totalRecipients++;
                    const response = invite.responses && invite.responses[recipientId] ? invite.responses[recipientId] : 'pending';
                    if (response === 'accepted') accepted++;
                    else if (response === 'declined') declined++;
                    else pending++;
                });
            });

            document.getElementById('analyticsTotal').textContent = totalRecipients;
            document.getElementById('analyticsAccepted').textContent = accepted;
            document.getElementById('analyticsPending').textContent = pending;
            document.getElementById('analyticsDeclined').textContent = declined;

            // Render detailed analytics
            const detailsContainer = document.getElementById('analyticsDetails');
            if (invitations.length === 0) {
                detailsContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); padding: 40px;">No invitations to track yet</p>';
                return;
            }

            detailsContainer.innerHTML = invitations.map(invite => {
                const responses = invite.recipients.map(recipientId => {
                    const contact = contacts.find(c => c.id === recipientId);
                    const response = invite.responses && invite.responses[recipientId] ? invite.responses[recipientId] : 'pending';
                    return { contact, response };
                });

                const acceptedCount = responses.filter(r => r.response === 'accepted').length;
                const pendingCount = responses.filter(r => r.response === 'pending').length;
                const declinedCount = responses.filter(r => r.response === 'declined').length;

                return `
                    <div class="card" style="margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px; font-weight: 600;">${invite.title}</h4>
                        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                            <span class="status-badge" style="background: rgba(16, 185, 129, 0.1); color: var(--color-success);">‚úÖ ${acceptedCount} Accepted</span>
                            <span class="status-badge" style="background: rgba(245, 158, 11, 0.1); color: var(--color-warning);">‚è≥ ${pendingCount} Pending</span>
                            <span class="status-badge" style="background: rgba(239, 68, 68, 0.1); color: var(--color-error);">‚ùå ${declinedCount} Declined</span>
                        </div>
                        
                        <div style="display: grid; gap: 8px;">
                            ${responses.map(({ contact, response }) => contact ? `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--color-secondary); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="contact-avatar" style="width: 32px; height: 32px; font-size: 14px;">${contact.name.charAt(0)}</div>
                                        <div>
                                            <div style="font-weight: 600; font-size: 14px;">${contact.name}</div>
                                            <div style="font-size: 12px; color: var(--color-text-secondary);">${contact.phone}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select onchange="updateInvitationResponse(${invite.id}, ${contact.id}, this.value)" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-surface); cursor: pointer;">
                                            <option value="pending" ${response === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                                            <option value="accepted" ${response === 'accepted' ? 'selected' : ''}>‚úÖ Accepted</option>
                                            <option value="declined" ${response === 'declined' ? 'selected' : ''}>‚ùå Declined</option>
                                        </select>
                                        ${response === 'pending' ? `<button class="btn btn-secondary btn-sm" onclick="resendToContact(${invite.id}, ${contact.id})">üîÑ Resend</button>` : ''}
                                    </div>
                                </div>
                            ` : '').join('')}
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                            <button class="btn btn-secondary btn-sm" onclick="currentViewingInviteId = ${invite.id}; viewInvitation(${invite.id})">üëÅÔ∏è View Details</button>
                            ${pendingCount > 0 ? `<button class="btn btn-primary btn-sm" onclick="resendToPending(${invite.id})">üîÑ Resend to All Pending</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resendToContact(inviteId, contactId) {
            const invite = invitations.find(i => i.id === inviteId);
            const contact = contacts.find(c => c.id === contactId);
            if (invite && contact) {
                showNotification(`Resending "${invite.title}" to ${contact.name}`, 'success');
                // In production, this would trigger actual SMS/call/email
            }
        }

        function resendToPending(inviteId) {
            const invite = invitations.find(i => i.id === inviteId);
            if (invite) {
                const pendingCount = invite.recipients.filter(recipientId => {
                    const response = invite.responses && invite.responses[recipientId] ? invite.responses[recipientId] : 'pending';
                    return response === 'pending';
                }).length;
                
                showNotification(`Resending "${invite.title}" to ${pendingCount} pending recipient(s)`, 'success');
                // In production, this would trigger actual resend logic
            }
        }

        // Section switching
        function switchSection(sectionId) {
            // Remove active class from all sections and nav items
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Add active class to clicked section and nav item
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Find and activate the correct nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(sectionId)) {
                    item.classList.add('active');
                }
            });
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            if (modalId === 'createInviteModal') {
                renderVoiceSelection();
                renderRecipientSelection();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }

        // Notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const msg = document.getElementById('notificationMessage');

            const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
            icon.textContent = icons[type] || icons.info;
            msg.textContent = message;

            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Contact management
        function renderContacts() {
            const container = document.getElementById('contactsList');
            if (contacts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>No contacts yet. Add your first contact!</p></div>';
                return;
            }

            container.innerHTML = contacts.map(contact => `
                <div class="contact-item">
                    <div class="contact-info">
                        <div class="contact-avatar">${contact.name.charAt(0)}</div>
                        <div class="contact-details">
                            <h4>${contact.name}</h4>
                            <p>${contact.phone} ‚Ä¢ ${contact.group}</p>
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="btn btn-icon btn-secondary" onclick="editContact(${contact.id})" aria-label="Edit ${contact.name}">‚úèÔ∏è</button>
                        <button class="btn btn-icon btn-secondary" onclick="deleteContact(${contact.id})" aria-label="Delete ${contact.name}">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function addContact() {
            const name = document.getElementById('contactName').value;
            const phone = document.getElementById('contactPhone').value;
            const email = document.getElementById('contactEmail').value;
            const group = document.getElementById('contactGroup').value;

            if (!name || !phone) {
                showNotification('Please fill in required fields', 'error');
                return;
            }

            const newContact = {
                id: Date.now(),
                name,
                phone,
                email,
                group
            };

            contacts.push(newContact);
            saveToLocalStorage();
            renderContacts();
            closeModal('addContactModal');
            showNotification('Contact added successfully!', 'success');

            // Clear form
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactEmail').value = '';
        }

        async function deleteContact(id) {
            if (confirm('Are you sure you want to delete this contact?')) {
                contacts = contacts.filter(c => c.id !== id);
                await deleteContactFromFirebase(id);
                await saveToLocalStorage();
                renderContacts();
                showNotification('Contact deleted', 'info');
            }
        }

        function editContact(id) {
            showNotification('Edit functionality coming soon!', 'info');
        }

        // Voice recording with improved microphone handling
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                // Check if running on localhost or HTTPS
                if (window.location.protocol === 'file:') {
                    showNotification('‚ùå SECURITY ERROR: Cannot access microphone from file://. You must run a local server. See instructions in the Voice Clone section above.', 'error');
                    return;
                }
                
                // Check if MediaRecorder is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showNotification('‚ùå Your browser does not support audio recording. Please use Chrome, Firefox, or Edge.', 'error');
                    return;
                }

                // Request microphone access with basic constraints for better compatibility
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingSeconds = 0;

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioPlayback = document.getElementById('audioPlayback');
                    audioPlayback.src = audioUrl;
                    
                    // Store the blob for later use
                    audioPlayback.dataset.blob = audioUrl;
                    
                    document.getElementById('recordedAudioContainer').style.display = 'block';
                    
                    // Stop all tracks to release microphone
                    stream.getTracks().forEach(track => track.stop());
                    
                    showNotification('‚úÖ Recording saved! You can play it back now.', 'success');
                };

                mediaRecorder.start();
                isRecording = true;

                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('waveform').classList.add('active');
                document.getElementById('recordingStatus').textContent = 'Recording in progress...';

                recordingInterval = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    document.getElementById('recordingTime').textContent = 
                        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }, 1000);

                showNotification('üéôÔ∏è Recording started! Speak clearly into your microphone.', 'success');
            } catch (error) {
                console.error('Error accessing microphone:', error);
                
                // Provide specific error messages with solutions
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    showNotification('‚ùå Microphone access denied. Please allow microphone permissions in your browser settings and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showNotification('‚ùå No microphone found. Please connect a microphone and try again.', 'error');
                } else if (error.name === 'NotReadableError') {
                    showNotification('‚ùå Microphone is already in use by another application. Please close other apps using the microphone.', 'error');
                } else if (error.message && error.message.includes('security origin')) {
                    showNotification('‚ùå SECURITY ERROR: You must run this on a local server (localhost) or HTTPS. See instructions in Voice Clone section.', 'error');
                } else {
                    showNotification('‚ùå Error accessing microphone: ' + error.message + ' - Try running on localhost server.', 'error');
                }
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(recordingInterval);

                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('waveform').classList.remove('active');
                document.getElementById('recordingStatus').textContent = 'Recording complete!';

                showNotification('Recording stopped', 'info');
            }
        }

        async function saveVoiceClone() {
            const audioPlayback = document.getElementById('audioPlayback');
            if (!audioPlayback.src) {
                showNotification('No recording to save', 'error');
                return;
            }

            showNotification('Uploading voice recording...', 'info');

            const voiceId = Date.now();
            
            // Get the audio blob from the chunks
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            
            // Upload to Firebase Storage (or use blob URL as fallback)
            const audioUrl = await uploadVoiceToStorage(audioBlob, voiceId);

            const voiceClone = {
                id: voiceId,
                name: `Voice Clone ${voiceClones.length + 1}`,
                duration: recordingSeconds,
                audioUrl: audioUrl,
                createdAt: new Date().toISOString()
            };

            voiceClones.push(voiceClone);
            await saveToLocalStorage();
            renderVoiceClones();
            discardRecording();
            
            if (isFirebaseConfigured()) {
                showNotification('‚úÖ Voice clone saved to Firebase!', 'success');
            } else {
                showNotification('Voice clone saved locally!', 'success');
            }
        }

        function discardRecording() {
            document.getElementById('recordedAudioContainer').style.display = 'none';
            document.getElementById('audioPlayback').src = '';
            recordingSeconds = 0;
            document.getElementById('recordingTime').textContent = '00:00';
            document.getElementById('recordingStatus').textContent = 'Click to start recording';
        }

        function renderVoiceClones() {
            const container = document.getElementById('voicesList');
            if (voiceClones.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No voice clones saved yet</p></div>';
                return;
            }

            container.innerHTML = voiceClones.map(voice => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="font-weight: 600;">${voice.name}</h4>
                        <span style="font-size: 12px; color: var(--color-text-secondary);">
                            ${Math.floor(voice.duration / 60)}:${String(voice.duration % 60).padStart(2, '0')}
                        </span>
                    </div>
                    <div class="audio-player">
                        <audio src="${voice.audioUrl}" controls></audio>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-secondary btn-sm" onclick="deleteVoiceClone(${voice.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteVoiceClone(id) {
            if (confirm('Delete this voice clone?')) {
                voiceClones = voiceClones.filter(v => v.id !== id);
                await deleteVoiceCloneFromFirebase(id);
                await saveToLocalStorage();
                renderVoiceClones();
                showNotification('Voice clone deleted', 'info');
            }
        }

        // Invitations
        function renderInvitations() {
            const container = document.getElementById('invitationsList');
            if (invitations.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üíå</div><p>No invitations yet. Create your first one!</p></div>';
                return;
            }

            container.innerHTML = invitations.map(invite => {
                const theme = detectEventTheme(invite.title);
                return `
                <div class="card" style="background: ${theme.gradient}; border-left: 4px solid ${theme.color};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h3 style="font-weight: 600; margin-bottom: 8px; color: ${theme.color};">${theme.icon} ${invite.title}</h3>
                            <p style="color: var(--color-text-secondary); margin-bottom: 8px;">${invite.message}</p>
                            <p style="font-size: 12px; color: var(--color-text-secondary);">
                                Sent to ${invite.recipients.length} contact(s)
                            </p>
                        </div>
                        <span class="status-badge status-${invite.status}">${invite.status}</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="viewInvitation(${invite.id})">üëÅÔ∏è View</button>
                        <button class="btn btn-secondary btn-sm" onclick="trackInvitation(${invite.id})">üìä Track</button>
                        <button class="btn btn-secondary btn-sm" onclick="deleteInvitation(${invite.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `}).join('');
        }

        function renderVoiceSelection() {
            const container = document.getElementById('voiceSelection');
            if (voiceClones.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No voice clones available. Record one first!</p></div>';
                return;
            }

            container.innerHTML = voiceClones.map(voice => `
                <div class="card" style="cursor: pointer;" onclick="selectVoice(${voice.id})">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="radio" name="voiceSelect" value="${voice.id}" id="voice${voice.id}">
                        <label for="voice${voice.id}" style="flex: 1; cursor: pointer;">
                            <h4 style="font-weight: 600; margin-bottom: 4px;">${voice.name}</h4>
                            <p style="font-size: 12px; color: var(--color-text-secondary);">Duration: ${Math.floor(voice.duration / 60)}:${String(voice.duration % 60).padStart(2, '0')}</p>
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function selectVoice(id) {
            document.getElementById(`voice${id}`).checked = true;
        }

        function renderRecipientSelection() {
            const container = document.getElementById('recipientSelection');
            if (contacts.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No contacts available. Add contacts first!</p></div>';
                return;
            }

            container.innerHTML = contacts.map(contact => `
                <div class="contact-item">
                    <div class="contact-info">
                        <input type="checkbox" id="recipient${contact.id}" value="${contact.id}">
                        <div class="contact-avatar">${contact.name.charAt(0)}</div>
                        <label for="recipient${contact.id}" style="cursor: pointer;">
                            <div class="contact-details">
                                <h4>${contact.name}</h4>
                                <p>${contact.phone}</p>
                            </div>
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function createInvitation() {
            const title = document.getElementById('inviteTitle').value;
            const message = document.getElementById('inviteMessage').value;
            const eventDate = document.getElementById('eventDate').value;
            const location = document.getElementById('eventLocation').value;

            if (!title || !message) {
                showNotification('Please fill in required fields', 'error');
                return;
            }

            const selectedRecipients = Array.from(document.querySelectorAll('input[id^="recipient"]:checked'))
                .map(cb => parseInt(cb.value));

            if (selectedRecipients.length === 0) {
                showNotification('Please select at least one recipient', 'error');
                return;
            }

            // ‚úÖ FIX 1: Initialize all recipients as "pending"
            const responses = {};
            selectedRecipients.forEach(recipientId => {
                responses[recipientId] = 'pending';
            });

            const newInvitation = {
                id: Date.now(),
                title,
                message,
                eventDate,
                location,
                recipients: selectedRecipients,
                responses: responses,  // ‚úÖ ADD RESPONSES INITIALIZATION
                status: 'sent',
                date: new Date().toISOString()
            };

            invitations.push(newInvitation);
            saveToLocalStorage();
            renderInvitations();
            renderAnalytics();  // ‚úÖ REFRESH ANALYTICS
            closeModal('createInviteModal');
            showNotification('Invitation sent successfully!', 'success');

            // Update stats
            updateDashboardStats();

            // Clear form
            document.getElementById('inviteTitle').value = '';
            document.getElementById('inviteMessage').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventLocation').value = '';
        }

        // Theme detection and styling
        function detectEventTheme(title) {
            const titleLower = title.toLowerCase();
            
            if (titleLower.includes('birthday') || titleLower.includes('bday')) {
                return {
                    name: 'birthday',
                    icon: 'üéÇ',
                    gradient: 'linear-gradient(135deg, rgba(255, 107, 181, 0.15) 0%, rgba(255, 193, 7, 0.15) 100%)',
                    decoration: 'üéÇüéàüéÅüéâüéä',
                    decorationSize: '80px',
                    decorationPattern: 'repeat',
                    color: '#e91e63'
                };
            } else if (titleLower.includes('wedding') || titleLower.includes('marriage')) {
                return {
                    name: 'wedding',
                    icon: 'üíí',
                    gradient: 'linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(219, 39, 119, 0.1) 100%)',
                    decoration: 'üííüíêüíïüíçüë∞',
                    decorationSize: '100px',
                    decorationPattern: 'elegant',
                    color: '#db2777'
                };
            } else if (titleLower.includes('party') || titleLower.includes('celebration')) {
                return {
                    name: 'party',
                    icon: 'üéâ',
                    gradient: 'linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(219, 39, 119, 0.15) 100%)',
                    decoration: 'üéâü•≥üéäüçæüéà',
                    decorationSize: '90px',
                    decorationPattern: 'scattered',
                    color: '#8b5cf6'
                };
            } else if (titleLower.includes('meeting') || titleLower.includes('conference')) {
                return {
                    name: 'meeting',
                    icon: 'üìÖ',
                    gradient: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%)',
                    decoration: 'üìÖüíºüìäüìàüñäÔ∏è',
                    decorationSize: '70px',
                    decorationPattern: 'professional',
                    color: '#3b82f6'
                };
            } else if (titleLower.includes('anniversary')) {
                return {
                    name: 'anniversary',
                    icon: 'üíù',
                    gradient: 'linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%)',
                    decoration: 'üíùüåπüíï‚ù§Ô∏è‚ú®',
                    decorationSize: '95px',
                    decorationPattern: 'romantic',
                    color: '#ef4444'
                };
            } else {
                return {
                    name: 'custom',
                    icon: '‚ú®',
                    gradient: 'linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%)',
                    decoration: '‚ú®üåü‚≠êüí´üéä',
                    decorationSize: '85px',
                    decorationPattern: 'sparkle',
                    color: '#6366f1'
                };
            }
        }

        function previewInvitation() {
            const title = document.getElementById('inviteTitle').value;
            const message = document.getElementById('inviteMessage').value;
            const eventDate = document.getElementById('eventDate').value;
            const location = document.getElementById('eventLocation').value;

            if (!title || !message) {
                showNotification('Please fill in title and message first', 'error');
                return;
            }

            const selectedRecipients = Array.from(document.querySelectorAll('input[id^="recipient"]:checked'))
                .map(cb => parseInt(cb.value));
            
            const selectedVoiceId = document.querySelector('input[name="voiceSelect"]:checked')?.value;
            const selectedVoice = voiceClones.find(v => v.id === parseInt(selectedVoiceId));

            openModal('previewModal');
            
            // Detect theme and apply styling
            const theme = detectEventTheme(title);
            const previewCard = document.getElementById('previewCard');
            const previewDecoration = document.getElementById('previewDecoration');
            const previewTitle = document.getElementById('previewTitle');
            
            // Apply theme - enhanced with vibrant colors and borders
            previewCard.style.background = theme.gradient;
            previewCard.style.borderLeft = `5px solid ${theme.color}`;
            previewCard.style.borderRight = `5px solid ${theme.color}`;
            previewCard.style.borderTop = `2px solid ${theme.color}`;
            previewCard.style.borderBottom = `2px solid ${theme.color}`;
            previewTitle.style.color = theme.color;
            
            // Apply theme color to detail cards
            document.getElementById('previewDateCard').style.borderLeftColor = theme.color;
            document.getElementById('previewLocationCard').style.borderLeftColor = theme.color;
            document.getElementById('previewGuestsCard').style.borderLeftColor = theme.color;
            
            // Apply theme color to labels
            const labels = document.querySelectorAll('#previewDateCard > div > div:first-child, #previewLocationCard > div > div:first-child, #previewGuestsCard > div > div:first-child');
            labels.forEach(label => {
                label.style.color = theme.color;
            });
            
            // Apply unique decoration pattern
            previewDecoration.style.fontSize = theme.decorationSize;
            previewDecoration.style.opacity = '0.08';
            
            // Create decorative pattern based on theme
            let decorationHTML = '';
            // Split emojis properly using spread operator to handle multi-byte characters
            const emojiArray = [...theme.decoration];
            
            if (theme.decorationPattern === 'repeat') {
                // Birthday - scattered repeating pattern all over
                for (let i = 0; i < emojiArray.length; i++) {
                    decorationHTML += `<span style="position: absolute; top: ${10 + i * 18}%; right: ${-5 + i * 12}%; font-size: ${theme.decorationSize}; opacity: 0.08;">${emojiArray[i]}</span>`;
                    decorationHTML += `<span style="position: absolute; top: ${60 + i * 8}%; left: ${5 + i * 10}%; font-size: ${theme.decorationSize}; opacity: 0.08;">${emojiArray[i]}</span>`;
                }
            } else if (theme.decorationPattern === 'elegant') {
                // Wedding - elegant corner cascade with rotation
                for (let i = 0; i < emojiArray.length; i++) {
                    const size = parseInt(theme.decorationSize) - i * 8;
                    decorationHTML += `<span style="position: absolute; top: ${8 + i * 16}%; right: ${5}%; font-size: ${size}px; transform: rotate(${i * 12}deg); opacity: 0.08;">${emojiArray[i]}</span>`;
                }
            } else if (theme.decorationPattern === 'scattered') {
                // Party - fun scattered everywhere
                for (let i = 0; i < emojiArray.length; i++) {
                    decorationHTML += `<span style="position: absolute; top: ${12 + i * 17}%; right: ${2 + (i % 2) * 15}%; font-size: ${theme.decorationSize}; transform: rotate(${i * -25}deg); opacity: 0.08;">${emojiArray[i]}</span>`;
                    if (i % 2 === 0) {
                        decorationHTML += `<span style="position: absolute; top: ${40 + i * 10}%; left: ${10 + i * 8}%; font-size: ${theme.decorationSize}; transform: rotate(${i * 20}deg); opacity: 0.06;">${emojiArray[i]}</span>`;
                    }
                }
            } else if (theme.decorationPattern === 'professional') {
                // Meeting - organized vertical stack
                for (let i = 0; i < emojiArray.length; i++) {
                    decorationHTML += `<span style="position: absolute; top: ${20 + i * 16}%; right: ${8}%; font-size: ${theme.decorationSize}; opacity: 0.07;">${emojiArray[i]}</span>`;
                }
            } else if (theme.decorationPattern === 'romantic') {
                // Anniversary - heart cascade with wave effect
                for (let i = 0; i < emojiArray.length; i++) {
                    const rightPos = 5 + Math.sin(i * 0.8) * 8;
                    decorationHTML += `<span style="position: absolute; top: ${8 + i * 18}%; right: ${rightPos}%; font-size: ${theme.decorationSize}; transform: rotate(${i * 8}deg); opacity: 0.08;">${emojiArray[i]}</span>`;
                }
            } else {
                // Custom - sparkle pattern with animation
                for (let i = 0; i < emojiArray.length; i++) {
                    decorationHTML += `<span style="position: absolute; top: ${15 + i * 19}%; right: ${6 + (i % 3) * 6}%; font-size: ${theme.decorationSize}; animation: pulse 2s infinite ${i * 0.4}s; opacity: 0.08;">${emojiArray[i]}</span>`;
                }
            }
            
            previewDecoration.innerHTML = decorationHTML;
            previewDecoration.style.pointerEvents = 'none';
            
            // Add theme icon to title and subtitle
            previewTitle.innerHTML = `${theme.icon} ${title} ${theme.icon}`;
            
            // Set theme-specific subtitle
            const subtitles = {
                'birthday': 'You\'re Invited to Celebrate!',
                'wedding': 'Join Us for Our Special Day',
                'party': 'Let\'s Party Together!',
                'meeting': 'Your Attendance is Requested',
                'anniversary': 'Celebrate With Us',
                'custom': 'You\'re Cordially Invited'
            };
            document.getElementById('previewSubtitle').textContent = subtitles[theme.name] || subtitles['custom'];
            
            // Set theme-specific footer with enhanced styling
            const footers = {
                'birthday': 'üéÇ Can\'t wait to celebrate with you! üéÇ',
                'wedding': 'üíí Looking forward to sharing our joy with you üíí',
                'party': 'üéâ It won\'t be the same without you! üéâ',
                'meeting': 'üìÖ We value your participation üìÖ',
                'anniversary': 'üíù Your presence would mean the world to us üíù',
                'custom': '‚ú® Hope to see you there! ‚ú®'
            };
            document.getElementById('previewFooter').innerHTML = `<div style="font-size: 20px; font-weight: 700; color: ${theme.color}; text-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 16px; background: rgba(255,255,255,0.6); border-radius: 12px; border: 2px dashed ${theme.color};">${footers[theme.name] || footers['custom']}</div>`;
            
            // Populate preview
            document.getElementById('previewMessage').textContent = message;
            document.getElementById('previewDate').textContent = eventDate ? new Date(eventDate).toLocaleString() : 'Not specified';
            document.getElementById('previewLocation').textContent = location || 'Not specified';
            document.getElementById('previewRecipients').textContent = selectedRecipients.length > 0 
                ? `${selectedRecipients.length} recipient(s) selected` 
                : 'No recipients selected';
            
            // Show voice player if voice selected
            const voicePreview = document.getElementById('previewVoice');
            if (selectedVoice) {
                voicePreview.innerHTML = `
                    <h4 style="margin-bottom: 8px;">Voice Recording: ${selectedVoice.name}</h4>
                    <audio src="${selectedVoice.audioUrl}" controls style="width: 100%;"></audio>
                `;
                voicePreview.style.display = 'block';
            } else {
                voicePreview.style.display = 'none';
            }
        }

        function viewInvitation(id) {
            const invite = invitations.find(i => i.id === id);
            if (!invite) return;

            openModal('viewInvitationModal');
            
            document.getElementById('viewTitle').textContent = invite.title;
            document.getElementById('viewMessage').textContent = invite.message;
            document.getElementById('viewDate').textContent = invite.eventDate ? new Date(invite.eventDate).toLocaleString() : 'Not specified';
            document.getElementById('viewLocation').textContent = invite.location || 'Not specified';
            document.getElementById('viewStatus').textContent = invite.status;
            document.getElementById('viewStatus').className = `status-badge status-${invite.status}`;
            
            // Show recipient responses
            const recipientsContainer = document.getElementById('viewRecipients');
            const recipientsList = invite.recipients.map(recipientId => {
                const contact = contacts.find(c => c.id === recipientId);
                const response = invite.responses && invite.responses[recipientId] ? invite.responses[recipientId] : 'pending';
                return contact ? `
                    <div class="contact-item" style="margin-bottom: 8px;">
                        <div class="contact-info">
                            <div class="contact-avatar">${contact.name.charAt(0)}</div>
                            <div class="contact-details">
                                <h4>${contact.name}</h4>
                                <p>${contact.phone}</p>
                            </div>
                        </div>
                        <span class="status-badge status-${response}">${response}</span>
                    </div>
                ` : '';
            }).join('');
            
            recipientsContainer.innerHTML = recipientsList || '<p>No recipients</p>';
        }

        function resendInvitation(id) {
            const invite = invitations.find(i => i.id === id);
            if (invite) {
                showNotification(`Resending invitation: ${invite.title}`, 'success');
                // In production, this would trigger actual resend logic
            }
        }

        function updateInvitationResponse(inviteId, recipientId, response) {
            const invite = invitations.find(i => i.id === inviteId);
            if (invite) {
                if (!invite.responses) invite.responses = {};
                invite.responses[recipientId] = response;
                saveToLocalStorage();
                renderAnalytics();  // ‚úÖ FIX 2: REFRESH ANALYTICS IMMEDIATELY
                renderInvitations();
                viewInvitation(inviteId); // Refresh the view
                showNotification(`Response updated to: ${response}`, 'success');
            }
        }

        function trackInvitation(id) {
            showNotification('Tracking details will be shown here', 'info');
        }

        async function deleteInvitation(id) {
            if (confirm('Delete this invitation?')) {
                invitations = invitations.filter(i => i.id !== id);
                await deleteInvitationFromFirebase(id);
                await saveToLocalStorage();
                renderInvitations();
                updateDashboardStats();
                showNotification('Invitation deleted', 'info');
            }
        }

        // Templates
        function renderTemplates() {
            const container = document.getElementById('templateGrid');
            container.innerHTML = templates.map(template => `
                <div class="template-card" data-template="${template.name.toLowerCase()}" onclick="selectTemplate(${template.id})">
                    <div class="template-icon">${template.icon}</div>
                    <div class="template-name">${template.name}</div>
                    <div class="template-description">${template.description}</div>
                </div>
            `).join('');
        }

        function selectTemplate(id) {
            const template = templates.find(t => t.id === id);
            showNotification(`Selected: ${template.name} template`, 'success');
            openModal('createInviteModal');
        }

        // Dashboard stats
        function updateDashboardStats() {
            document.getElementById('totalInvites').textContent = invitations.length;
            document.getElementById('deliveredCount').textContent = 
                invitations.filter(i => i.status === 'delivered').length;
            document.getElementById('pendingCount').textContent = 
                invitations.filter(i => i.status === 'pending').length;
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Make nav items keyboard accessible
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    item.click();
                }
            });
        });
    </script>
</body>
</html>
