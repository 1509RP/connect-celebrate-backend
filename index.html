<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect & Celebrate - AI Event Invitations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .btn-primary { @apply bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:shadow-xl transition-all duration-300; }
        .btn-secondary { @apply bg-white text-gray-700 font-semibold py-3 px-6 rounded-lg border-2 border-gray-300 hover:border-blue-500 hover:shadow-lg transition-all duration-300; }
        .input-field { @apply w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all; }
        .status-badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
        .modal-overlay { @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm; }
        .recording-pulse { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .waveform { animation: waveform 1s ease-in-out infinite; }
        @keyframes waveform { 0%, 100% { height: 20px; } 50% { height: 60px; } }
        .toast { @apply fixed top-4 right-4 bg-white rounded-lg shadow-xl p-4 z-50 transform transition-all duration-300; }
        .tab-active { @apply bg-gradient-to-r from-blue-600 to-cyan-600 text-white; }
        .tab-inactive { @apply text-gray-600 hover:bg-gray-100; }
        .contact-card { @apply border-2 rounded-lg p-4 transition-all duration-300 cursor-pointer; }
        .contact-card:hover { @apply border-blue-400 bg-blue-50; }
        .contact-card.selected { @apply border-blue-600 bg-blue-100 ring-2 ring-blue-300; }
    </style>
</head>
<body class="min-h-screen">

<div id="app"></div>

<div id="toast-container"></div>

<script>
const API_URL = window.location.origin + '/api';

const state = {
    activeTab: 'create',
    events: [],
    contacts: [],
    voiceSamples: [],
    invitations: [],
    currentEvent: {
        title: '',
        date: '',
        time: '',
        location: '',
        description: '',
        host: '',
        template: 'modern',
        customTemplate: null,
        dressCode: '',
        rsvpDeadline: null
    },
    selectedContacts: [],
    isRecording: false,
    recordingData: null,
    audioChunks: [],
    mediaRecorder: null,
    recordingTime: 0,
    recordingInterval: null,
    showModal: null,
    currentEventForInvite: null,
    stats: {
        total_contacts: 0,
        total_events: 0,
        total_invitations: 0,
        accepted: 0,
        declined: 0,
        pending: 0,
        maybe: 0
    },
    editingContact: null,
    customTemplateEditor: '',
    selectedEvent: null
};

const templates = {
    modern: {
        bg: 'bg-gradient-to-br from-blue-50 to-cyan-100',
        accent: 'text-blue-600',
        border: 'border-blue-300',
        gradient: 'from-blue-600 to-cyan-600'
    },
    elegant: {
        bg: 'bg-gradient-to-br from-rose-50 to-pink-100',
        accent: 'text-rose-600',
        border: 'border-rose-300',
        gradient: 'from-rose-600 to-pink-600'
    },
    casual: {
        bg: 'bg-gradient-to-br from-green-50 to-emerald-100',
        accent: 'text-green-600',
        border: 'border-green-300',
        gradient: 'from-green-600 to-emerald-600'
    }
};

async function fetchData() {
    try {
        const [eventsRes, contactsRes, voiceRes, statsRes] = await Promise.all([
            fetch(`${API_URL}/events`),
            fetch(`${API_URL}/contacts`),
            fetch(`${API_URL}/voice-samples`),
            fetch(`${API_URL}/stats`)
        ]);

        const eventsData = await eventsRes.json();
        const contactsData = await contactsRes.json();
        const voiceData = await voiceRes.json();
        const statsData = await statsRes.json();

        if (eventsData.success) state.events = eventsData.data;
        if (contactsData.success) state.contacts = contactsData.data;
        if (voiceData.success) state.voiceSamples = voiceData.data;
        if (statsData.success) state.stats = statsData.data;

    } catch (error) {
        showToast('Error loading data', 'error');
    }
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    toast.className = `toast ${bgColor} text-white`;
    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}"></i>
            <span>${message}</span>
        </div>
    `;
    container.appendChild(toast);
    lucide.createIcons();
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

async function render() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-xl">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center gap-3">
                            <i data-lucide="calendar" class="h-8 w-8"></i>
                            Connect & Celebrate
                        </h1>
                        <p class="text-blue-100 mt-1">AI-Powered Voice Invitation System</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="text-2xl font-bold">${state.stats.total_events}</div>
                            <div class="text-xs text-blue-100">Events</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold">${state.stats.total_contacts}</div>
                            <div class="text-xs text-blue-100">Contacts</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex gap-2 bg-white rounded-xl p-2 shadow-lg mb-6">
                ${['create', 'manage', 'contacts', 'voice', 'templates'].map(tab => `
                    <button onclick="changeTab('${tab}')" class="flex-1 py-3 rounded-lg font-semibold transition ${state.activeTab === tab ? 'tab-active' : 'tab-inactive'}">
                        <i data-lucide="${getTabIcon(tab)}" class="inline h-5 w-5 mr-2"></i>
                        ${tab.charAt(0).toUpperCase() + tab.slice(1)}
                    </button>
                `).join('')}
            </div>

            ${getTabContent()}
        </div>

        ${state.showModal ? renderModal() : ''}
    `;
    lucide.createIcons();
}

function getTabIcon(tab) {
    const icons = {
        create: 'plus-circle',
        manage: 'list-checks',
        contacts: 'users',
        voice: 'mic',
        templates: 'palette'
    };
    return icons[tab] || 'circle';
}

function getTabContent() {
    switch(state.activeTab) {
        case 'create': return renderCreateTab();
        case 'manage': return renderManageTab();
        case 'contacts': return renderContactsTab();
        case 'voice': return renderVoiceTab();
        case 'templates': return renderTemplatesTab();
        default: return '';
    }
}

function renderCreateTab() {
    return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i data-lucide="edit-3" class="h-6 w-6 text-blue-600"></i>
                    Create Event
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Event Title</label>
                        <input type="text" placeholder="Summer Pool Party" value="${state.currentEvent.title}"
                               oninput="updateField('title', this.value)" class="input-field" aria-label="Event Title">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                            <input type="date" value="${state.currentEvent.date}"
                                   oninput="updateField('date', this.value)" class="input-field" aria-label="Event Date">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Time</label>
                            <input type="time" value="${state.currentEvent.time}"
                                   oninput="updateField('time', this.value)" class="input-field" aria-label="Event Time">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                        <input type="text" placeholder="123 Main Street" value="${state.currentEvent.location}"
                               oninput="updateField('location', this.value)" class="input-field" aria-label="Event Location">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Host Name</label>
                        <input type="text" placeholder="John Doe" value="${state.currentEvent.host}"
                               oninput="updateField('host', this.value)" class="input-field" aria-label="Host Name">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea placeholder="Join us for an amazing celebration..."
                                  oninput="updateField('description', this.value)"
                                  class="input-field" rows="3" aria-label="Event Description">${state.currentEvent.description}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Dress Code (Optional)</label>
                        <input type="text" placeholder="Casual" value="${state.currentEvent.dressCode}"
                               oninput="updateField('dressCode', this.value)" class="input-field" aria-label="Dress Code">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Choose Template</label>
                        <div class="grid grid-cols-3 gap-3">
                            ${Object.keys(templates).map(key => `
                                <button onclick="updateField('template', '${key}')"
                                        class="p-4 rounded-lg ${templates[key].bg} ${state.currentEvent.template === key ? 'ring-4 ring-offset-2 ' + templates[key].border : 'hover:scale-105'} transition-all"
                                        aria-label="Select ${key} template">
                                    <div class="${templates[key].accent} font-semibold capitalize">${key}</div>
                                    <div class="text-xs text-gray-500 mt-1">Click to select</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="createEvent()" class="w-full btn-primary">
                        <i data-lucide="sparkles" class="inline h-5 w-5 mr-2"></i>
                        Create Event
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i data-lucide="eye" class="h-6 w-6 text-blue-600"></i>
                    Live Preview
                </h2>
                <div id="preview" class="p-8 rounded-xl ${templates[state.currentEvent.template].bg} ${templates[state.currentEvent.template].border} border-2 shadow-inner">
                    <div class="text-center space-y-4">
                        <div class="animate-float">
                            <i data-lucide="calendar-heart" class="h-16 w-16 ${templates[state.currentEvent.template].accent} mx-auto mb-4"></i>
                        </div>
                        <h3 class="text-3xl font-bold ${templates[state.currentEvent.template].accent}">
                            ${state.currentEvent.title || 'Your Event Title'}
                        </h3>
                        <div class="space-y-3 text-gray-700">
                            <p class="flex items-center justify-center gap-2 text-lg">
                                <i data-lucide="calendar" class="h-5 w-5"></i>
                                ${state.currentEvent.date || 'Select Date'} at ${state.currentEvent.time || 'Select Time'}
                            </p>
                            <p class="flex items-center justify-center gap-2 text-lg">
                                <i data-lucide="map-pin" class="h-5 w-5"></i>
                                ${state.currentEvent.location || 'Add Location'}
                            </p>
                            ${state.currentEvent.host ? `
                                <p class="flex items-center justify-center gap-2">
                                    <i data-lucide="user" class="h-5 w-5"></i>
                                    Hosted by: <strong>${state.currentEvent.host}</strong>
                                </p>
                            ` : ''}
                            ${state.currentEvent.description ? `
                                <p class="mt-6 italic text-gray-600 px-4">${state.currentEvent.description}</p>
                            ` : ''}
                            ${state.currentEvent.dressCode ? `
                                <p class="flex items-center justify-center gap-2">
                                    <i data-lucide="shirt" class="h-5 w-5"></i>
                                    Dress Code: <strong>${state.currentEvent.dressCode}</strong>
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderManageTab() {
    return `
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                ${[
                    { label: 'Total Invitations', value: state.stats.total_invitations, color: 'blue', icon: 'mail' },
                    { label: 'Accepted', value: state.stats.accepted, color: 'green', icon: 'check-circle' },
                    { label: 'Declined', value: state.stats.declined, color: 'red', icon: 'x-circle' },
                    { label: 'Pending', value: state.stats.pending, color: 'yellow', icon: 'clock' }
                ].map(s => `
                    <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">${s.label}</p>
                                <p class="text-4xl font-bold text-${s.color}-600 mt-2">${s.value}</p>
                            </div>
                            <i data-lucide="${s.icon}" class="h-12 w-12 text-${s.color}-400"></i>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i data-lucide="calendar-check" class="h-6 w-6 text-blue-600"></i>
                    Your Events
                </h2>
                ${state.events.length === 0 ? `
                    <div class="text-center py-16">
                        <i data-lucide="calendar-x" class="h-24 w-24 text-gray-300 mx-auto mb-6 animate-float"></i>
                        <p class="text-xl text-gray-400 mb-2">No events yet</p>
                        <p class="text-gray-500 mb-6">Create your first event to get started</p>
                        <button onclick="changeTab('create')" class="btn-primary">
                            <i data-lucide="plus" class="inline h-5 w-5 mr-2"></i>
                            Create Event
                        </button>
                    </div>
                ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${state.events.map(e => `
                            <div class="border-2 rounded-xl p-6 card-hover bg-gradient-to-br ${templates[e.template]?.bg || templates.modern.bg}">
                                <div class="flex items-start justify-between mb-4">
                                    <h3 class="font-bold text-xl ${templates[e.template]?.accent || templates.modern.accent}">${e.title}</h3>
                                    <button onclick="deleteEvent('${e.id}')" class="text-red-500 hover:text-red-700 transition" aria-label="Delete event">
                                        <i data-lucide="trash-2" class="h-5 w-5"></i>
                                    </button>
                                </div>
                                <div class="space-y-2 text-sm text-gray-700 mb-4">
                                    <p class="flex items-center gap-2">
                                        <i data-lucide="calendar" class="h-4 w-4"></i>
                                        ${e.date} at ${e.time}
                                    </p>
                                    <p class="flex items-center gap-2">
                                        <i data-lucide="map-pin" class="h-4 w-4"></i>
                                        ${e.location}
                                    </p>
                                    ${e.host ? `
                                        <p class="flex items-center gap-2">
                                            <i data-lucide="user" class="h-4 w-4"></i>
                                            ${e.host}
                                        </p>
                                    ` : ''}
                                </div>
                                <button onclick="openInviteModal('${e.id}')" class="w-full bg-gradient-to-r ${templates[e.template]?.gradient || templates.modern.gradient} text-white py-3 rounded-lg font-semibold hover:shadow-xl transition-all">
                                    <i data-lucide="send" class="inline h-4 w-4 mr-2"></i>
                                    Send Invitations
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
        </div>
    `;
}

function renderContactsTab() {
    const groups = ['All', 'Friends', 'Family', 'Colleagues', 'Other'];
    const currentGroup = state.contactFilter || 'All';
    const filteredContacts = currentGroup === 'All'
        ? state.contacts
        : state.contacts.filter(c => c.group === currentGroup);

    return `
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="users" class="h-6 w-6 text-blue-600"></i>
                        Contacts (${state.contacts.length})
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="showModal('addContact')" class="btn-primary">
                            <i data-lucide="user-plus" class="inline h-5 w-5 mr-2"></i>
                            Add Contact
                        </button>
                        <button onclick="showModal('importContacts')" class="btn-secondary">
                            <i data-lucide="upload" class="inline h-5 w-5 mr-2"></i>
                            Import
                        </button>
                    </div>
                </div>

                <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                    ${groups.map(g => `
                        <button onclick="filterContacts('${g}')"
                                class="px-4 py-2 rounded-lg font-medium transition-all whitespace-nowrap ${currentGroup === g ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                            ${g}
                        </button>
                    `).join('')}
                </div>

                ${state.selectedContacts.length > 0 ? `
                    <div class="mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-blue-900">
                                <i data-lucide="check-square" class="inline h-5 w-5 mr-2"></i>
                                ${state.selectedContacts.length} selected
                            </span>
                            <button onclick="clearSelection()" class="text-blue-600 hover:text-blue-800 font-medium">
                                Clear Selection
                            </button>
                        </div>
                    </div>
                ` : ''}

                ${filteredContacts.length === 0 ? `
                    <div class="text-center py-16">
                        <i data-lucide="user-x" class="h-24 w-24 text-gray-300 mx-auto mb-6"></i>
                        <p class="text-xl text-gray-400 mb-2">No contacts yet</p>
                        <p class="text-gray-500 mb-6">Add contacts to send invitations</p>
                        <button onclick="showModal('addContact')" class="btn-primary">
                            <i data-lucide="user-plus" class="inline h-5 w-5 mr-2"></i>
                            Add Your First Contact
                        </button>
                    </div>
                ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${filteredContacts.map(c => `
                            <div onclick="toggleContact('${c.id}')"
                                 class="contact-card ${state.selectedContacts.includes(c.id) ? 'selected' : ''}"
                                 role="button" tabindex="0" aria-pressed="${state.selectedContacts.includes(c.id)}">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-white font-bold text-lg">
                                            ${c.name.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-lg">${c.name}</h3>
                                            <span class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-700">${c.group}</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="event.stopPropagation(); editContact('${c.id}')"
                                                class="text-blue-500 hover:text-blue-700 transition"
                                                aria-label="Edit contact">
                                            <i data-lucide="edit" class="h-4 w-4"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteContact('${c.id}')"
                                                class="text-red-500 hover:text-red-700 transition"
                                                aria-label="Delete contact">
                                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-1 text-sm text-gray-600">
                                    ${c.email ? `
                                        <p class="flex items-center gap-2">
                                            <i data-lucide="mail" class="h-4 w-4"></i>
                                            ${c.email}
                                        </p>
                                    ` : ''}
                                    ${c.phone ? `
                                        <p class="flex items-center gap-2">
                                            <i data-lucide="phone" class="h-4 w-4"></i>
                                            ${c.phone}
                                        </p>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
        </div>
    `;
}

function renderVoiceTab() {
    const hasVoiceSample = state.voiceSamples.length > 0;
    const recordingTimeFormatted = formatTime(state.recordingTime);

    return `
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-center mb-8 flex items-center justify-center gap-2">
                    <i data-lucide="mic-2" class="h-6 w-6 text-blue-600"></i>
                    Voice Cloning Setup
                </h2>

                <div class="text-center mb-8">
                    <div class="w-48 h-48 mx-auto mb-6 rounded-full flex items-center justify-center ${state.isRecording ? 'bg-red-100 recording-pulse' : 'bg-gradient-to-br from-blue-100 to-cyan-100'} shadow-xl">
                        ${state.isRecording ? `
                            <div class="relative">
                                <i data-lucide="mic" class="h-24 w-24 text-red-600"></i>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="flex gap-1">
                                        <div class="w-2 bg-red-600 rounded waveform" style="animation-delay: 0s"></div>
                                        <div class="w-2 bg-red-600 rounded waveform" style="animation-delay: 0.1s"></div>
                                        <div class="w-2 bg-red-600 rounded waveform" style="animation-delay: 0.2s"></div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <i data-lucide="${hasVoiceSample ? 'check-circle' : 'mic'}" class="h-24 w-24 ${hasVoiceSample ? 'text-green-600' : 'text-blue-600'}"></i>
                        `}
                    </div>

                    ${state.isRecording ? `
                        <div class="mb-6">
                            <div class="text-4xl font-bold text-red-600 mb-2">${recordingTimeFormatted}</div>
                            <p class="text-gray-600">Recording in progress...</p>
                        </div>
                    ` : hasVoiceSample ? `
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold text-green-600 mb-2 flex items-center justify-center gap-2">
                                <i data-lucide="sparkles" class="h-6 w-6"></i>
                                Voice Sample Ready!
                            </h3>
                            <p class="text-gray-600">Your AI voice is ready to use for invitations</p>
                        </div>
                    ` : `
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold mb-3">Record Your Voice</h3>
                            <p class="text-gray-600 mb-4">Record at least 30 seconds of your voice for AI cloning</p>
                        </div>
                    `}

                    ${!hasVoiceSample && !state.isRecording ? `
                        <div class="bg-gray-50 p-6 rounded-xl mb-6 text-left max-w-2xl mx-auto">
                            <h4 class="font-semibold mb-3 flex items-center gap-2">
                                <i data-lucide="book-open" class="h-5 w-5 text-blue-600"></i>
                                Sample Script:
                            </h4>
                            <p class="text-sm italic text-gray-700 leading-relaxed">
                                "Hi there! I hope this message finds you well. I wanted to personally invite you to my upcoming event.
                                It would mean so much to have you there. The celebration is going to be wonderful, and I really hope
                                you can make it. Please let me know if you can attend. Looking forward to seeing you!"
                            </p>
                        </div>
                    ` : ''}

                    <div class="flex gap-4 justify-center">
                        ${state.isRecording ? `
                            <button onclick="stopRecording()" class="px-8 py-4 bg-red-600 text-white rounded-lg font-bold text-lg hover:bg-red-700 transition-all shadow-xl">
                                <i data-lucide="square" class="inline h-6 w-6 mr-2"></i>
                                Stop Recording
                            </button>
                        ` : hasVoiceSample ? `
                            <button onclick="playVoiceSample()" class="px-8 py-4 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-all shadow-lg">
                                <i data-lucide="play" class="inline h-6 w-6 mr-2"></i>
                                Play Sample
                            </button>
                            <button onclick="resetVoice()" class="px-8 py-4 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 transition-all shadow-lg">
                                <i data-lucide="rotate-ccw" class="inline h-6 w-6 mr-2"></i>
                                Re-record
                            </button>
                        ` : `
                            <button onclick="startRecording()" class="px-8 py-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg font-bold text-lg hover:shadow-xl transition-all">
                                <i data-lucide="mic" class="inline h-6 w-6 mr-2"></i>
                                Start Recording
                            </button>
                        `}
                    </div>

                    ${hasVoiceSample ? `
                        <div class="mt-8 p-6 bg-green-50 rounded-xl border-2 border-green-200">
                            <h4 class="font-semibold text-green-900 mb-3 flex items-center justify-center gap-2">
                                <i data-lucide="info" class="h-5 w-5"></i>
                                Voice Samples Saved
                            </h4>
                            <div class="space-y-3">
                                ${state.voiceSamples.map(v => `
                                    <div class="flex items-center justify-between bg-white p-4 rounded-lg">
                                        <div class="flex items-center gap-3">
                                            <i data-lucide="audio-lines" class="h-5 w-5 text-green-600"></i>
                                            <div class="text-left">
                                                <div class="font-semibold">${v.name}</div>
                                                <div class="text-sm text-gray-500">${v.duration}s â€¢ ${v.status}</div>
                                            </div>
                                        </div>
                                        <button onclick="deleteVoiceSample('${v.id}')" class="text-red-500 hover:text-red-700 transition">
                                            <i data-lucide="trash-2" class="h-5 w-5"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function renderTemplatesTab() {
    return `
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="palette" class="h-6 w-6 text-blue-600"></i>
                        Custom Templates
                    </h2>
                    <button onclick="showModal('createTemplate')" class="btn-primary">
                        <i data-lucide="plus" class="inline h-5 w-5 mr-2"></i>
                        Create Template
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    ${Object.keys(templates).map(key => `
                        <div class="border-2 rounded-xl p-6 ${templates[key].bg} ${templates[key].border}">
                            <h3 class="font-bold text-xl ${templates[key].accent} capitalize mb-2">${key}</h3>
                            <p class="text-sm text-gray-600 mb-4">Built-in ${key} design template</p>
                            <div class="p-4 bg-white bg-opacity-50 rounded-lg text-center">
                                <i data-lucide="file-text" class="h-12 w-12 ${templates[key].accent} mx-auto"></i>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="border-t-2 pt-6">
                    <h3 class="text-xl font-bold mb-4">Create Your Own Template</h3>
                    <p class="text-gray-600 mb-6">Design custom HTML templates for your invitations with full creative control.</p>
                    <button onclick="showModal('createTemplate')" class="btn-primary">
                        <i data-lucide="code" class="inline h-5 w-5 mr-2"></i>
                        Open Template Editor
                    </button>
                </div>
            </div>
        </div>
    `;
}

function renderModal() {
    const modal = state.showModal;

    if (modal === 'invite') {
        const event = state.events.find(e => e.id === state.currentEventForInvite);
        if (!event) return '';

        return `
            <div class="modal-overlay" onclick="closeModal()">
                <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="send" class="h-6 w-6 text-blue-600"></i>
                        Send Invitations for "${event.title}"
                    </h3>

                    ${state.selectedContacts.length === 0 ? `
                        <div class="text-center py-8">
                            <i data-lucide="users-round" class="h-16 w-16 text-gray-300 mx-auto mb-4"></i>
                            <p class="text-gray-600 mb-6">Please select contacts from the Contacts tab first</p>
                            <button onclick="closeModal(); changeTab('contacts')" class="btn-primary">
                                <i data-lucide="users" class="inline h-5 w-5 mr-2"></i>
                                Go to Contacts
                            </button>
                        </div>
                    ` : `
                        <div class="mb-6">
                            <p class="text-gray-600 mb-4">
                                <strong>${state.selectedContacts.length}</strong> contact(s) selected
                            </p>
                        </div>

                        <div class="space-y-3 mb-6">
                            <h4 class="font-semibold mb-3">Choose Delivery Method:</h4>
                            ${[
                                { method: 'email', icon: 'mail', label: 'Email', desc: 'Send via email with tracking' },
                                { method: 'sms', icon: 'message-square', label: 'SMS', desc: 'Send text message invitation' },
                                { method: 'voice', icon: 'phone-call', label: 'Voice Call', desc: 'AI voice call invitation', disabled: state.voiceSamples.length === 0 },
                                { method: 'audio', icon: 'audio-lines', label: 'Voice Message', desc: 'Send recorded voice message', disabled: state.voiceSamples.length === 0 }
                            ].map(m => `
                                <button onclick="sendInvitations('${m.method}')"
                                        ${m.disabled ? 'disabled' : ''}
                                        class="w-full p-4 border-2 rounded-lg hover:bg-gray-50 text-left font-semibold transition-all ${m.disabled ? 'opacity-50 cursor-not-allowed' : 'hover:border-blue-500'}">
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="${m.icon}" class="h-6 w-6 text-blue-600"></i>
                                        <div class="flex-1">
                                            <div class="font-bold">${m.label}</div>
                                            <div class="text-sm text-gray-500">${m.desc}</div>
                                            ${m.disabled ? '<div class="text-xs text-red-500 mt-1">Record voice sample first</div>' : ''}
                                        </div>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    `}

                    <button onclick="closeModal()" class="w-full mt-4 py-3 border-2 rounded-lg font-semibold hover:bg-gray-50 transition">
                        Cancel
                    </button>
                </div>
            </div>
        `;
    }

    if (modal === 'addContact') {
        return `
            <div class="modal-overlay" onclick="closeModal()">
                <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="user-plus" class="h-6 w-6 text-blue-600"></i>
                        ${state.editingContact ? 'Edit Contact' : 'Add New Contact'}
                    </h3>

                    <form onsubmit="saveContact(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Name *</label>
                            <input type="text" id="contact-name" placeholder="John Doe" required class="input-field"
                                   value="${state.editingContact?.name || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" id="contact-email" placeholder="john@example.com" class="input-field"
                                   value="${state.editingContact?.email || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="contact-phone" placeholder="+1-555-0123" class="input-field"
                                   value="${state.editingContact?.phone || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Group</label>
                            <select id="contact-group" class="input-field">
                                ${['Friends', 'Family', 'Colleagues', 'Other'].map(g => `
                                    <option value="${g}" ${state.editingContact?.group === g ? 'selected' : ''}>${g}</option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button type="submit" class="flex-1 btn-primary">
                                <i data-lucide="save" class="inline h-5 w-5 mr-2"></i>
                                ${state.editingContact ? 'Update' : 'Add'} Contact
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 btn-secondary">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    }

    if (modal === 'importContacts') {
        return `
            <div class="modal-overlay" onclick="closeModal()">
                <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="upload" class="h-6 w-6 text-blue-600"></i>
                        Import Contacts
                    </h3>

                    <div class="space-y-4">
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-500 transition">
                            <i data-lucide="file-up" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-600 mb-2">Upload CSV file</p>
                            <p class="text-sm text-gray-400 mb-4">Format: name, email, phone, group</p>
                            <input type="file" accept=".csv" onchange="handleFileUpload(event)" class="hidden" id="csv-upload">
                            <button onclick="document.getElementById('csv-upload').click()" class="btn-primary">
                                Choose File
                            </button>
                        </div>

                        <button onclick="closeModal()" class="w-full btn-secondary">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    if (modal === 'createTemplate') {
        return `
            <div class="modal-overlay" onclick="closeModal()">
                <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="code" class="h-6 w-6 text-blue-600"></i>
                        Create Custom Template
                    </h3>

                    <form onsubmit="saveTemplate(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Template Name</label>
                            <input type="text" id="template-name" placeholder="My Custom Template" required class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">HTML Content</label>
                            <textarea id="template-html" rows="15" placeholder="<div>Your HTML here...</div>" required
                                      class="input-field font-mono text-sm">${state.customTemplateEditor}</textarea>
                            <p class="text-sm text-gray-500 mt-2">Use variables: {{title}}, {{date}}, {{time}}, {{location}}, {{description}}</p>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="flex-1 btn-primary">
                                <i data-lucide="save" class="inline h-5 w-5 mr-2"></i>
                                Save Template
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 btn-secondary">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    }

    return '';
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        state.mediaRecorder = new MediaRecorder(stream);
        state.audioChunks = [];
        state.recordingTime = 0;

        state.mediaRecorder.ondataavailable = (event) => {
            state.audioChunks.push(event.data);
        };

        state.mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);

            const voiceData = {
                name: `Voice Sample ${new Date().toLocaleString()}`,
                audioUrl: audioUrl,
                duration: state.recordingTime,
                status: 'ready'
            };

            const response = await fetch(`${API_URL}/voice-samples`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(voiceData)
            });

            if (response.ok) {
                await fetchData();
                showToast('Voice sample saved successfully!', 'success');
            }

            stream.getTracks().forEach(track => track.stop());
            clearInterval(state.recordingInterval);
        };

        state.mediaRecorder.start();
        state.isRecording = true;

        state.recordingInterval = setInterval(() => {
            state.recordingTime++;
            render();
        }, 1000);

        render();
    } catch (error) {
        showToast('Microphone access denied', 'error');
        console.error('Error starting recording:', error);
    }
}

function stopRecording() {
    if (state.mediaRecorder && state.isRecording) {
        state.mediaRecorder.stop();
        state.isRecording = false;
        render();
    }
}

async function resetVoice() {
    if (confirm('Are you sure you want to delete all voice samples?')) {
        for (const sample of state.voiceSamples) {
            await fetch(`${API_URL}/voice-samples/${sample.id}`, { method: 'DELETE' });
        }
        await fetchData();
        showToast('Voice samples deleted', 'success');
        render();
    }
}

function playVoiceSample() {
    if (state.voiceSamples.length > 0 && state.voiceSamples[0].audio_url) {
        const audio = new Audio(state.voiceSamples[0].audio_url);
        audio.play();
        showToast('Playing voice sample', 'info');
    }
}

async function deleteVoiceSample(id) {
    if (confirm('Delete this voice sample?')) {
        await fetch(`${API_URL}/voice-samples/${id}`, { method: 'DELETE' });
        await fetchData();
        showToast('Voice sample deleted', 'success');
        render();
    }
}

function changeTab(tab) {
    state.activeTab = tab;
    render();
}

function updateField(field, value) {
    state.currentEvent[field] = value;
    updatePreview();
}

function updatePreview() {
    const preview = document.getElementById('preview');
    if (!preview) return;

    const template = templates[state.currentEvent.template];
    preview.className = `p-8 rounded-xl ${template.bg} ${template.border} border-2 shadow-inner`;
    preview.innerHTML = `
        <div class="text-center space-y-4">
            <div class="animate-float">
                <i data-lucide="calendar-heart" class="h-16 w-16 ${template.accent} mx-auto mb-4"></i>
            </div>
            <h3 class="text-3xl font-bold ${template.accent}">
                ${state.currentEvent.title || 'Your Event Title'}
            </h3>
            <div class="space-y-3 text-gray-700">
                <p class="flex items-center justify-center gap-2 text-lg">
                    <i data-lucide="calendar" class="h-5 w-5"></i>
                    ${state.currentEvent.date || 'Select Date'} at ${state.currentEvent.time || 'Select Time'}
                </p>
                <p class="flex items-center justify-center gap-2 text-lg">
                    <i data-lucide="map-pin" class="h-5 w-5"></i>
                    ${state.currentEvent.location || 'Add Location'}
                </p>
                ${state.currentEvent.host ? `
                    <p class="flex items-center justify-center gap-2">
                        <i data-lucide="user" class="h-5 w-5"></i>
                        Hosted by: <strong>${state.currentEvent.host}</strong>
                    </p>
                ` : ''}
                ${state.currentEvent.description ? `
                    <p class="mt-6 italic text-gray-600 px-4">${state.currentEvent.description}</p>
                ` : ''}
                ${state.currentEvent.dressCode ? `
                    <p class="flex items-center justify-center gap-2">
                        <i data-lucide="shirt" class="h-5 w-5"></i>
                        Dress Code: <strong>${state.currentEvent.dressCode}</strong>
                    </p>
                ` : ''}
            </div>
        </div>
    `;
    lucide.createIcons();
}

async function createEvent() {
    if (!state.currentEvent.title || !state.currentEvent.date || !state.currentEvent.time) {
        showToast('Please fill in title, date, and time', 'error');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/events`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(state.currentEvent)
        });

        const result = await response.json();
        if (result.success) {
            showToast('Event created successfully!', 'success');
            state.currentEvent = {
                title: '',
                date: '',
                time: '',
                location: '',
                description: '',
                host: '',
                template: 'modern',
                customTemplate: null,
                dressCode: '',
                rsvpDeadline: null
            };
            await fetchData();
            changeTab('manage');
        }
    } catch (error) {
        showToast('Failed to create event', 'error');
    }
}

async function deleteEvent(id) {
    if (confirm('Are you sure you want to delete this event?')) {
        await fetch(`${API_URL}/events/${id}`, { method: 'DELETE' });
        await fetchData();
        showToast('Event deleted', 'success');
        render();
    }
}

function toggleContact(id) {
    const index = state.selectedContacts.indexOf(id);
    if (index > -1) {
        state.selectedContacts.splice(index, 1);
    } else {
        state.selectedContacts.push(id);
    }
    render();
}

function clearSelection() {
    state.selectedContacts = [];
    render();
}

function filterContacts(group) {
    state.contactFilter = group;
    render();
}

function editContact(id) {
    state.editingContact = state.contacts.find(c => c.id === id);
    showModal('addContact');
}

async function deleteContact(id) {
    if (confirm('Delete this contact?')) {
        await fetch(`${API_URL}/contacts/${id}`, { method: 'DELETE' });
        await fetchData();
        showToast('Contact deleted', 'success');
        render();
    }
}

async function saveContact(event) {
    event.preventDefault();

    const contactData = {
        name: document.getElementById('contact-name').value,
        email: document.getElementById('contact-email').value,
        phone: document.getElementById('contact-phone').value,
        group: document.getElementById('contact-group').value
    };

    try {
        if (state.editingContact) {
            await fetch(`${API_URL}/contacts/${state.editingContact.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(contactData)
            });
            showToast('Contact updated!', 'success');
        } else {
            await fetch(`${API_URL}/contacts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(contactData)
            });
            showToast('Contact added!', 'success');
        }

        state.editingContact = null;
        await fetchData();
        closeModal();
        render();
    } catch (error) {
        showToast('Failed to save contact', 'error');
    }
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split('\\n').slice(1);
        const contacts = lines.map(line => {
            const [name, email, phone, group] = line.split(',').map(s => s.trim());
            return { name, email, phone, group: group || 'Friends' };
        }).filter(c => c.name);

        try {
            await fetch(`${API_URL}/contacts/bulk`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contacts })
            });
            showToast(`${contacts.length} contacts imported!`, 'success');
            await fetchData();
            closeModal();
            render();
        } catch (error) {
            showToast('Failed to import contacts', 'error');
        }
    };
    reader.readAsText(file);
}

function openInviteModal(eventId) {
    state.currentEventForInvite = eventId;
    showModal('invite');
}

async function sendInvitations(method) {
    if (state.selectedContacts.length === 0) {
        showToast('Please select contacts first', 'error');
        return;
    }

    try {
        const voiceUrl = state.voiceSamples.length > 0 ? state.voiceSamples[0].audio_url : null;

        await fetch(`${API_URL}/invitations/bulk-send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                eventId: state.currentEventForInvite,
                contactIds: state.selectedContacts,
                deliveryMethod: method,
                voiceMessageUrl: voiceUrl
            })
        });

        showToast(`Invitations sent via ${method}!`, 'success');
        state.selectedContacts = [];
        await fetchData();
        closeModal();
        render();
    } catch (error) {
        showToast('Failed to send invitations', 'error');
    }
}

async function saveTemplate(event) {
    event.preventDefault();

    const templateData = {
        name: document.getElementById('template-name').value,
        htmlContent: document.getElementById('template-html').value
    };

    try {
        await fetch(`${API_URL}/custom-templates`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(templateData)
        });
        showToast('Template saved!', 'success');
        closeModal();
    } catch (error) {
        showToast('Failed to save template', 'error');
    }
}

function showModal(modal) {
    state.showModal = modal;
    render();
}

function closeModal() {
    state.showModal = null;
    state.editingContact = null;
    render();
}

window.changeTab = changeTab;
window.updateField = updateField;
window.createEvent = createEvent;
window.deleteEvent = deleteEvent;
window.toggleContact = toggleContact;
window.clearSelection = clearSelection;
window.filterContacts = filterContacts;
window.editContact = editContact;
window.deleteContact = deleteContact;
window.saveContact = saveContact;
window.handleFileUpload = handleFileUpload;
window.openInviteModal = openInviteModal;
window.sendInvitations = sendInvitations;
window.saveTemplate = saveTemplate;
window.startRecording = startRecording;
window.stopRecording = stopRecording;
window.resetVoice = resetVoice;
window.playVoiceSample = playVoiceSample;
window.deleteVoiceSample = deleteVoiceSample;
window.showModal = showModal;
window.closeModal = closeModal;

fetchData().then(() => render());
</script>

</body>
</html>
